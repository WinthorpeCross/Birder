
<h2>Add an observation</h2>

<!-- Still to do:
  - Google maps API
  - Bind datepicker and setup date locale
  (set user at the controller level) -->

<div class="container">
  <div class="row">
      <div class='col-sm-2'>
      </div>
    <div class="col-sm-8">
      <div class="observation-add-container" *ngIf="addObservationForm">
        <h2 class="section-title">Add an observation</h2>
        <div *ngIf="invalidAddObservation" class="alert alert-danger">
          <p>There is an error in your observation</p>
            <ul>
                <li *ngFor="let error of errorReport.modelStateErrors">
                    {{ error }}
                </li>
            </ul>
        </div>

        <form [formGroup]="addObservationForm" novalidate (ngSubmit)="onSubmit(addObservationForm.value)">
          <!--  -->
          <div class="container">
            <h4>Location map</h4>
            <form (ngSubmit)="useGeolocation(searchAddress)">
              <input type="text" name="searchAddress" placeholder="Type location here" [(ngModel)]="searchAddress" [ngModelOptions]="{standalone: true}" required>
              <button type="submit" triggers="mouseenter:mouseleave"
                ngbPopover='- Type a place name (e.g. Canterbury, UK); or an specific address (e.g. 1 High St, Canterbury CT1 2JH)' 
                popoverTitle="Search help">Show Location</button>
              <button type="button" (click)="getCurrentPosition()">Use My Current Location</button>
            </form>
            
            <p *ngIf="geoError">
                <ngb-alert [dismissible]="true" [type]="'danger'" (close)="closeAlert()">
                  <strong>Warning!</strong> Better check yourself, you're not looking too good.
                </ngb-alert>
              </p>
            <p>latitude: {{addObservationForm.get('locationLatitude').value}}; longitude: {{addObservationForm.get('locationLongitude').value}}; address: {{geolocation}}</p>
            <agm-map [latitude]="addObservationForm.get('locationLatitude').value"
                     [longitude]="addObservationForm.get('locationLongitude').value"
                     [zoom]="8"
                     [disableDefaultUI]="false"
                     [zoomControl]="true">
              <agm-marker [latitude]="addObservationForm.get('locationLatitude').value"
                          [longitude]="addObservationForm.get('locationLongitude').value"
                          [markerDraggable]="true" 
                          (dragEnd)="placeMarker($event)">
                <agm-info-window [isOpen]="true">Observed at {{geolocation}}</agm-info-window>
              </agm-marker>
            </agm-map>
            <!-- <mat-icon color="primary">info</mat-icon><span class="aligned-with-icon"><small><em>You can change the location in
                  the <a routerLink="/observation-edit/{{observation.observationId}}">edit observation</a>
                  page</em></small></span> -->
          </div>
          <!--  -->
          <mat-form-field class="half-width">
            <input matInput type="quantity" placeholder="Quantity" formControlName="quantity" required>
            <mat-error *ngFor="let validation of addObservation_validation_messages.quantity">
              <mat-error class="error-message"
                *ngIf="addObservationForm.get('quantity').hasError(validation.type) && (addObservationForm.get('quantity').dirty || addObservationForm.get('quantity').touched)">
                {{validation.message}}</mat-error>
            </mat-error>
          </mat-form-field>

          <mat-form-field class="full-width">
            <mat-select placeholder="Select species" formControlName="birdId" type="birdId" required>
              <mat-option *ngFor="let bird of birdsSpecies" [value]="bird.birdId">
                {{bird.birdId}}, {{bird.englishName}}
              </mat-option>
            </mat-select>
            <mat-error *ngFor="let validation of addObservation_validation_messages.birdId">
              <mat-error class="error-message"
                *ngIf="addObservationForm.get('birdId').hasError(validation.type) && (addObservationForm.get('birdId').dirty || addObservationForm.get('birdId').touched)">
                {{validation.message}}</mat-error>
            </mat-error>
          </mat-form-field>

          <mat-form-field class="full-width">
            <input matInput [matDatepicker]="picker" placeholder="Choose a date" formControlName="observationDateTime">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>          

          <mat-form-field class="full-width">
            <textarea matInput type="noteGeneral" placeholder="General comments" formControlName="noteGeneral"></textarea>
          </mat-form-field>

          <mat-form-field class="full-width">
            <textarea matInput type="noteHabitat" placeholder="Comments on habitat" formControlName="noteHabitat"></textarea>
          </mat-form-field>

          <mat-form-field class="full-width">
            <textarea matInput type="noteWeather" placeholder="Comments on weather" formControlName="noteWeather"></textarea>
          </mat-form-field>

          <mat-form-field class="full-width">
            <textarea matInput type="noteAppearance" placeholder="Comments on appearance" formControlName="noteAppearance"></textarea>
          </mat-form-field>

          <mat-form-field class="full-width">
            <textarea matInput type="noteBehaviour" placeholder="Comments on behaviour" formControlName="noteBehaviour"></textarea>
          </mat-form-field>

          <mat-form-field class="full-width">
            <textarea matInput type="noteVocalisation" placeholder="Comments on song" formControlName="noteVocalisation"></textarea>
          </mat-form-field>

          <button class="submit-btn" color="primary" mat-raised-button type="submit" [disabled]="!addObservationForm.valid">
            Sumbit
          </button>

        </form>
      </div>

    </div>
    <div class='col-sm-2'>
      </div>
  </div>
</div>
